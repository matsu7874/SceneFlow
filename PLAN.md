# SceneFlow 次世代機能開発計画

## 🎉 モダン化完了

SceneFlowの基盤となるモダン化が完了しました：

- ✅ Vite + TypeScript環境への完全移行
- ✅ 包括的なテストスイート（80%以上のカバレッジ）
- ✅ CI/CD パイプライン構築
- ✅ セキュリティとパフォーマンスの最適化

---

# 開発計画書：物語作成支援機能 "Causal Story Weaver"

## 📊 進捗状況

- ✅ Phase 1: 因果律エンジンの基盤構築
- ✅ Phase 2: 高度なデータ構造とAct定義
- ✅ Phase 3: インタラクティブUI機能の実装
- ✅ Phase 4: 因果ビューと自動検証機能
- ✅ Phase 5: エンティティ編集とJSONエディタ
- ✅ Phase 6: 場所の接続関係可視化
- ⬜ Phase 7: 統合テストとリリース準備

## 🎯 目標

既存のSceneFlowに、登場人物の行動（Act）が持つ因果関係を自動検証できる機能を追加し、整合性の取れた複雑な物語の構築を支援する高度なツールに進化させる。

---

## Phase 1: 因果律エンジンの基盤構築 ✅

### 1.1 拡張型定義の作成

- [x] `src/types/causality.ts` を作成
  - [x] 事前条件・事後条件を持つActインターフェース
  - [x] WorldState型（人物の位置、所有物、知識状態）
  - [x] CausalLink型（因果関係の表現）

### 1.2 Act実装の基本構造

- [x] `src/modules/causality/acts/` ディレクトリを作成
- [x] BaseActクラスの実装
  ```typescript
  abstract class BaseAct {
    abstract checkPreconditions(state: WorldState): boolean
    abstract applyPostconditions(state: WorldState): WorldState
    abstract getDescription(): string
  }
  ```
- [x] 基本的なActの実装
  - [x] MoveAct（移動）
  - [x] GiveItemAct（アイテム受け渡し）
  - [x] TakeItemAct（アイテム取得）
  - [x] PlaceItemAct（アイテム配置）

### 1.3 因果律エンジンのコア実装

- [x] `src/modules/causality/engine.ts` を作成
- [x] タイムライン整合性チェック機能
- [x] 状態のロールバック・ロールフォワード機能
- [x] 因果関係の追跡機能

---

## Phase 2: 高度なデータ構造とAct定義 ✅

### 2.1 拡張エンティティの実装

- [x] `src/types/extendedEntities.ts` を作成
  - [x] 大道具・小道具の区別
  - [x] 情報（Information）エンティティ
  - [x] 人物の知識状態管理

### 2.2 複雑なActの実装

- [x] SpeakAct（情報の共有）
- [x] UseItemAct（アイテムの使用）
- [x] CombineItemsAct（アイテムの合成）
- [ ] 条件付きAct（特定の状態でのみ実行可能）

### 2.3 状態管理の拡張

- [x] `src/modules/state/extendedState.ts` を作成
- [x] 既存のstateと新しい因果律状態の統合
- [x] 状態の永続化（LocalStorage/IndexedDB）

---

## Phase 3: インタラクティブUI機能の実装 ✅

### 3.1 ドラッグ&ドロップ機能

- [x] `src/modules/ui/dragDrop.ts` を作成
- [x] 人物の移動をドラッグ&ドロップで実現
- [x] アイテムの受け渡しUI
- [x] リアルタイム整合性チェック

### 3.2 ビジュアルフィードバック

- [x] 実行可能なActのハイライト表示
- [x] 実行不可能な理由の表示
- [x] アニメーション付き状態遷移

### 3.3 タイムライン編集UI

- [x] Act の追加・削除・並び替え
- [x] 時間軸上での Act 配置
- [x] 複数の Act の一括編集

---

## Phase 4: 因果ビューと自動検証機能 ✅

### 4.1 因果関係の可視化

- [x] `src/modules/ui/causalityView.ts` を作成
- [x] グラフベースの因果関係表示
- [x] 「なぜこの状態になったか」の逆引き追跡
- [x] 影響範囲の可視化

### 4.2 自動検証機能

- [x] 物語の論理的整合性チェック
- [x] 到達不可能な状態の検出
- [x] デッドロックの検出
- [x] 推奨される Act の提案

### 4.3 検証結果レポート

- [x] 問題箇所のハイライト
- [x] 修正提案の表示
- [x] 検証結果のエクスポート

---

## Phase 5: エンティティ編集とJSONエディタ ✅

### 5.1 高度なエンティティエディタ

- [x] `src/modules/ui/entityEditor/` を作成
- [x] フォームベースの編集UI
- [x] リレーション編集（接続関係など）
- [x] バリデーション機能

### 5.2 JSONエディタの強化

- [x] シンタックスハイライト
- [x] スキーマ検証
- [x] オートコンプリート
- [x] Diff表示機能

### 5.3 インポート/エクスポート機能

- [x] 複数フォーマット対応（JSON, YAML, CSV, XML）
- [x] 部分的なインポート/エクスポート
- [x] バージョン管理対応

---

## Phase 6: 場所の接続関係可視化 ✅

### 6.1 ノードベースのマップエディタ

- [x] `src/modules/ui/mapEditor/MapEditor.ts` を作成
- [x] ドラッグ可能なノード（場所）
- [x] 接続関係の視覚的編集
- [x] 自動レイアウト機能

### 6.2 3D/2.5D表示オプション

- [x] 立体的な場所配置
- [x] 階層構造の表現
- [x] ミニマップ機能

### 6.3 経路探索と分析

- [x] 最短経路の計算・表示（A*アルゴリズム）
- [x] 到達可能性の分析
- [x] ボトルネックの検出

---

## Phase 7: 統合テストとリリース準備 ⬜

### 7.1 E2Eテストの実装

- [ ] Playwright または Cypress の導入
- [ ] 主要なユーザーフローのテスト
- [ ] ビジュアルリグレッションテスト

### 7.2 パフォーマンス最適化

- [ ] 大規模データ（1000+ Acts）での動作検証
- [ ] メモリ使用量の最適化
- [ ] レンダリングパフォーマンスの改善

### 7.3 ドキュメントとチュートリアル

- [ ] ユーザーガイドの作成
- [ ] API ドキュメント
- [ ] サンプルストーリーの提供
- [ ] インタラクティブチュートリアル

---

## ✅ 完了基準

- [ ] すべての新機能が実装され、テスト済み
- [ ] 既存機能との完全な互換性
- [ ] パフォーマンステストに合格（1000+ Acts で 60fps）
- [ ] ドキュメントが完備
- [ ] アクセシビリティ基準を満たす

## ⚠️ 技術的考慮事項

- 既存のコードベースを最大限活用し、破壊的変更を避ける
- 新機能は段階的に有効化できるようフィーチャーフラグを使用
- モバイル対応を考慮した設計
- 国際化（i18n）の準備

## 🔄 段階的リリース計画

1. **v2.0-alpha**: Phase 1-2 完了時点でアルファ版リリース
2. **v2.0-beta**: Phase 3-4 完了時点でベータ版リリース
3. **v2.0**: Phase 7 完了後に正式リリース

---

_このドキュメントは開発の進行に応じて更新されます。_
